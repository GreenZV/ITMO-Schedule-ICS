name: ITMO Schedule Parser Runner

on: 
  workflow_dispatch:
  push:
    branches: [ main ]
  # Run twice daily at 7:00 and 19:00 Moscow Time (UTC+3)
  schedule:
    - cron: '0 3,15 * * *'  # 4:00 and 16:00 UTC = 7:00 and 19:00 Moscow Time
  
concurrency:
  group: itmo-schedule-parser
  cancel-in-progress: true
  
jobs:
  run-python:
    name: Run Python Script
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent infinite runs
    permissions:
      contents: write
    
    env:
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      TOKEN: ${{ secrets.TOKEN }}
      REPO: ${{ secrets.REPO }}
      DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
      DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
      DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}

      UV_LINK_MODE: copy
      UV_CACHE_DIR: ~/.cache/uv
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Prepare uv cache
        run: mkdir -p /home/runner/.cache/uv

      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Create venv
        run: uv venv .venv

      - name: Install deps (FAST)
        run: |
          source .venv/bin/activate
          uv pip install -r requirements.txt
        
      - name: Restore runtime cache
        uses: actions/cache@v4
        with:
          path: |
            .session_cache
            logs
            data
          key: runtime-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            runtime-${{ runner.os }}-
        
      - name: Run
        run: |
          source .venv/bin/activate
          python main.py

      - name: Commit and push README
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          git commit -m "auto-update README.md"

          git push
    
      - name: Save runtime cache
        if: success()
        uses: actions/cache@v4
        with:
          path: |
            .session_cache
            logs
            data
          key: runtime-${{ runner.os }}-${{ github.ref_name }}
